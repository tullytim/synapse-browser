name: Build Synapse Browser

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Import Code Signing Certificates
      if: ${{ github.event_name != 'pull_request' && env.APPLE_CERTIFICATE != '' }}
      env:
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
        APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # Create variables
        CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

        # Import certificate from secrets
        echo -n "$APPLE_CERTIFICATE" | base64 --decode > $CERTIFICATE_PATH

        # Verify certificate file was created and has content
        if [ ! -f "$CERTIFICATE_PATH" ]; then
          echo "Error: Certificate file not created"
          exit 1
        fi

        FILE_SIZE=$(wc -c < "$CERTIFICATE_PATH")
        echo "Certificate file size: $FILE_SIZE bytes"
        if [ "$FILE_SIZE" -lt 100 ]; then
          echo "Error: Certificate file seems too small, likely decode failed"
          exit 1
        fi

        # Inspect the .p12 file contents (without password first to see structure)
        echo "Inspecting certificate contents..."
        openssl pkcs12 -in $CERTIFICATE_PATH -passin pass:"$APPLE_CERTIFICATE_PASSWORD" -info -nokeys -nocerts 2>&1 || true

        # Check certificate validity dates
        echo "Certificate details:"
        CERT_INFO=$(openssl pkcs12 -in $CERTIFICATE_PATH -passin pass:"$APPLE_CERTIFICATE_PASSWORD" -nokeys -clcerts 2>/dev/null | openssl x509 -noout -subject -dates 2>/dev/null)
        echo "$CERT_INFO"

        # Check if certificate is currently valid
        if openssl pkcs12 -in $CERTIFICATE_PATH -passin pass:"$APPLE_CERTIFICATE_PASSWORD" -nokeys -clcerts 2>/dev/null | openssl x509 -noout -checkend 0 2>/dev/null; then
          echo "✓ Certificate is currently valid"
        else
          echo "✗ WARNING: Certificate may not be valid yet or has expired"
        fi

        # Check if private key exists in the .p12
        echo "Checking for private key..."
        if openssl pkcs12 -in $CERTIFICATE_PATH -passin pass:"$APPLE_CERTIFICATE_PASSWORD" -nocerts -nodes 2>/dev/null | grep -q "BEGIN PRIVATE KEY"; then
          echo "✓ Private key found in .p12 file"
        else
          echo "✗ ERROR: No private key found in .p12 file!"
          echo "The .p12 must contain BOTH the certificate AND private key."
          echo ""
          echo "To fix this:"
          echo "1. In Keychain Access, expand the 'Developer ID Application' certificate"
          echo "2. You should see a private key underneath it"
          echo "3. Select BOTH items (Cmd+Click)"
          echo "4. Right-click → Export 2 items..."
          echo "5. Ensure you're exporting both the certificate AND private key"
          echo ""
          exit 1
        fi

        # List all certificates in the p12 (including intermediate certs)
        echo "All certificates in .p12 file:"
        openssl pkcs12 -in $CERTIFICATE_PATH -passin pass:"$APPLE_CERTIFICATE_PASSWORD" -nokeys 2>/dev/null | openssl x509 -noout -subject -issuer 2>/dev/null || echo "Could not list certificates"

        # Download Apple intermediate certificates
        echo "Downloading Apple intermediate certificates..."
        curl -sS -o $RUNNER_TEMP/AppleWWDRCAG3.cer https://www.apple.com/certificateauthority/AppleWWDRCAG3.cer

        # Download and convert Developer ID CA certificate
        curl -sS https://www.apple.com/certificateauthority/DeveloperIDCA.cer | \
          openssl x509 -inform DER -outform PEM -out $RUNNER_TEMP/DeveloperIDCA.pem

        # Create temporary keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # Add keychain to search list
        security list-keychain -d user -s $KEYCHAIN_PATH $(security list-keychains -d user | sed s/\"//g)

        # Import Apple intermediate certificates first
        echo "Importing Apple intermediate certificates..."
        security import $RUNNER_TEMP/AppleWWDRCAG3.cer -k $KEYCHAIN_PATH -A -T /usr/bin/codesign -T /usr/bin/productbuild || echo "Could not import WWDR G3"
        security import $RUNNER_TEMP/DeveloperIDCA.pem -k $KEYCHAIN_PATH -A -T /usr/bin/codesign -T /usr/bin/productbuild || echo "Could not import Developer ID CA"

        # Extract certificate and key, then rebuild with full chain
        echo "Extracting and rebuilding certificate with full chain..."

        # Extract the private key (use legacy format for compatibility)
        openssl pkcs12 -in $CERTIFICATE_PATH -passin pass:"$APPLE_CERTIFICATE_PASSWORD" -nocerts -nodes -legacy -out $RUNNER_TEMP/key.pem 2>/dev/null || \
          openssl pkcs12 -in $CERTIFICATE_PATH -passin pass:"$APPLE_CERTIFICATE_PASSWORD" -nocerts -nodes -out $RUNNER_TEMP/key.pem

        # Extract the certificate
        openssl pkcs12 -in $CERTIFICATE_PATH -passin pass:"$APPLE_CERTIFICATE_PASSWORD" -clcerts -nokeys -legacy -out $RUNNER_TEMP/cert.pem 2>/dev/null || \
          openssl pkcs12 -in $CERTIFICATE_PATH -passin pass:"$APPLE_CERTIFICATE_PASSWORD" -clcerts -nokeys -out $RUNNER_TEMP/cert.pem

        # Create a new p12 with the full chain (use -certfile for chain and -legacy for compatibility)
        openssl pkcs12 -export -out $RUNNER_TEMP/fullchain.p12 \
          -inkey $RUNNER_TEMP/key.pem \
          -in $RUNNER_TEMP/cert.pem \
          -certfile $RUNNER_TEMP/DeveloperIDCA.pem \
          -passout pass:"$APPLE_CERTIFICATE_PASSWORD" \
          -legacy 2>/dev/null || \
        openssl pkcs12 -export -out $RUNNER_TEMP/fullchain.p12 \
          -inkey $RUNNER_TEMP/key.pem \
          -in $RUNNER_TEMP/cert.pem \
          -certfile $RUNNER_TEMP/DeveloperIDCA.pem \
          -passout pass:"$APPLE_CERTIFICATE_PASSWORD"

        # Import the rebuilt certificate with full chain
        echo "Importing certificate with full chain..."
        if ! security import $RUNNER_TEMP/fullchain.p12 -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH -T /usr/bin/codesign -T /usr/bin/productbuild; then
          echo "Error: Failed to import certificate. Check APPLE_CERTIFICATE_PASSWORD is correct."
          exit 1
        fi

        # Clean up sensitive files
        rm -f $RUNNER_TEMP/key.pem $RUNNER_TEMP/cert.pem $RUNNER_TEMP/fullchain.p12

        # Show all identities in keychain (not just codesigning)
        echo "All identities in keychain:"
        security find-identity -v $KEYCHAIN_PATH

        # Verify certificate was imported for codesigning
        echo "Code signing identities:"
        security find-identity -v -p codesigning $KEYCHAIN_PATH

        if security find-identity -v -p codesigning $KEYCHAIN_PATH | grep -q "0 valid identities found"; then
          echo ""
          echo "Error: No valid CODE SIGNING identities found after import."
          echo "The certificate imported successfully but doesn't contain a 'Developer ID Application' certificate."
          echo "Please ensure APPLE_CERTIFICATE contains a .p12 file exported from a Developer ID Application certificate."
          echo ""
          exit 1
        fi

        # Set default keychain
        security default-keychain -s $KEYCHAIN_PATH

        # Unlock keychain again (sometimes needed after setting as default)
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # Enable codesigning from keychain - partition list for all items
        security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

    - name: Build macOS app
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      run: npm run build-mac

    - name: Clean up keychain
      if: ${{ always() && env.APPLE_CERTIFICATE != '' }}
      env:
        APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
      run: |
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: synapse-browser-macos
        path: |
          dist/*.dmg
          dist/*.zip
        if-no-files-found: warn

  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Build Windows app
      env:
        DEBUG: electron-builder
      run: npm run build-win

    - name: List dist directory
      if: always()
      run: |
        echo "Contents of dist directory:"
        dir dist\ 2>$null || echo "dist directory not found"

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: synapse-browser-windows
        path: |
          dist/*.exe
        if-no-files-found: warn

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Build Linux app
      run: npm run build-linux

    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: synapse-browser-linux
        path: |
          dist/*.AppImage
          dist/*.deb
          dist/*.rpm
        if-no-files-found: warn
